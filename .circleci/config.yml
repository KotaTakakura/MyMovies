version: 2.1
#orbs:
#  aws-ecr: circleci/aws-ecr@6.12.2
#  aws-ecs: circleci/aws-ecs@1.2.0
#workflows:
#  build-and-deploy:
#    jobs:
#      - aws-ecr/build-and-push-image:
#          account-url: AWS_ECR_ACCOUNT_URL
#          aws-access-key-id: AWS_ACCESS_KEY_ID
#          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
#          create-repo: true
#          dockerfile: Dockerfile-go
#          path: .
#          region: AWS_REGION
#          repo: mp-go
#          tag: "$CIRCLE_SHA1"
#          filters:
#            branches:
#              only: master
      # - aws-ecs/deploy-service-update:
      #     requires:
      #       - aws-ecr/build-and-push-image
      #     family: 'Go'
      #     cluster-name: 'mypipe'
      #     service-name: 'sss'
jobs:
  build:
    docker:
      - image: circleci/golang:latest
      - image: circleci/mysql:5.7
        environment:
          MYSQL_DATABASE: 'mypipe'
          MYSQL_USER: 'root'
          MYSQL_ROOT_PASSWORD: 'root'
    steps:
      - checkout

      - run:
          name: install_migrate
          command: sudo apt-get update && apt-get upgrade -y && sudo apt-get install -y curl gnupg2 vim && sudo curl -L https://github.com/golang-migrate/migrate/releases/download/v4.11.0/migrate.linux-amd64.tar.gz | tar xvz && sudo mv ./migrate.linux-amd64 /usr/bin/migrate

      - run:
          name: go_build
          command: cd ./go/src/MyPIPE && go build

      - run:
          name: usecaseTest
          command: cd ./go/src/MyPIPE && go test -v ./Test/usecase/...

      - run:
          name: valueObjectTest
          command: cd ./go/src/MyPIPE && go test -v ./Test/model/value_object/...

      - run:
          name: migrationTest
          command: cd ./go/src/MyPIPE && migrate -database "mysql://root:root@127.0.0.1/mypipe" -path ./Migrations up

#      - restore_cache:
#          key: mod-{{ checksum "go.sum" }}

#      - run: go build -o main main.go
#      - run: go build

#      - store_artifacts:
#          path: main
#          destination: main
#
#      - save_cache:
#          key: mod-{{ checksum "go.sum" }}
#          paths:
#            - $GOPATH/pkg/mod